<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EdilPavia · Pannello Admin</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background: #f4f7fc;
      font-family: 'Segoe UI', Roboto, sans-serif;
    }
    .admin-header {
      background: #0b3b5c;
      color: white;
      padding: 20px 0;
      margin-bottom: 30px;
    }
    .admin-header h1 {
      margin: 0;
      font-size: 2rem;
    }
    .admin-header i {
      color: #f5a623;
      margin-right: 10px;
    }
    .table-container {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }
    .btn-add {
      background: #0b3b5c;
      color: white;
      border-radius: 40px;
      padding: 10px 25px;
      font-weight: 600;
      margin-bottom: 20px;
      border: none;
    }
    .btn-add:hover {
      background: #124f73;
    }
    .btn-edit {
      background: #f5a623;
      color: #0b3b5c;
      border: none;
      border-radius: 30px;
      padding: 5px 15px;
      font-weight: 600;
      margin-right: 5px;
    }
    .btn-delete {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 30px;
      padding: 5px 15px;
      font-weight: 600;
    }
    .modal-header {
      background: #0b3b5c;
      color: white;
    }
    .modal-header .btn-close {
      filter: brightness(0) invert(1);
    }
    .preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .preview-item {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #ddd;
    }
    .preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .preview-item .remove-img {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(220, 53, 69, 0.8);
      color: white;
      border: none;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="admin-header">
    <div class="container">
      <h1><i class="fas fa-cogs"></i> Pannello di Amministrazione</h1>
      <p class="mb-0">Gestione servizi · EdilPavia</p>
    </div>
  </div>

  <div class="container">
    <div class="table-container">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-list me-2"></i>Elenco servizi</h3>
        <button class="btn-add" data-bs-toggle="modal" data-bs-target="#addModal">
          <i class="fas fa-plus me-2"></i>Nuovo servizio
        </button>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Icona</th>
              <th>Titolo</th>
              <th>Descrizione breve</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody id="serviziTableBody">
            <!-- Popolato via JS -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODALE AGGIUNTA -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Nuovo servizio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addForm">
            <div class="mb-3">
              <label class="form-label">Icona (classe FontAwesome, es. "fas fa-hard-hat")</label>
              <input type="text" class="form-control" id="addIcona" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Titolo</label>
              <input type="text" class="form-control" id="addTitolo" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Descrizione breve</label>
              <textarea class="form-control" id="addDescBreve" rows="2" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Descrizione estesa</label>
              <textarea class="form-control" id="addDescEstesa" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Immagini (URL, uno per riga)</label>
              <textarea class="form-control" id="addImmagini" rows="3" placeholder="https://..."></textarea>
              <div class="preview-container" id="addPreview"></div>
              <button type="button" class="btn btn-sm btn-secondary mt-2" id="addAggiungiUrl">Aggiungi riga</button>
            </div>
            <div class="mb-3">
              <label class="form-label">Prezzo indicativo (es. "da € 500")</label>
              <input type="text" class="form-control" id="addPrezzo">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="salvaNuovo">Salva servizio</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALE MODIFICA -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifica servizio</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editId">
            <div class="mb-3">
              <label class="form-label">Icona (classe FontAwesome)</label>
              <input type="text" class="form-control" id="editIcona" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Titolo</label>
              <input type="text" class="form-control" id="editTitolo" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Descrizione breve</label>
              <textarea class="form-control" id="editDescBreve" rows="2" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Descrizione estesa</label>
              <textarea class="form-control" id="editDescEstesa" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Immagini (URL, uno per riga)</label>
              <textarea class="form-control" id="editImmagini" rows="3" placeholder="https://..."></textarea>
              <div class="preview-container" id="editPreview"></div>
              <button type="button" class="btn btn-sm btn-secondary mt-2" id="editAggiungiUrl">Aggiungi riga</button>
            </div>
            <div class="mb-3">
              <label class="form-label">Prezzo indicativo</label>
              <input type="text" class="form-control" id="editPrezzo">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="salvaModifiche">Aggiorna servizio</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/servizi-data.js"></script>
  <script>
    (function() {
      // Riferimenti ai modali
      const addModalEl = document.getElementById('addModal');
      const editModalEl = document.getElementById('editModal');
      let addModal, editModal;

      // Inizializza modali Bootstrap
      if (addModalEl) addModal = new bootstrap.Modal(addModalEl);
      if (editModalEl) editModal = new bootstrap.Modal(editModalEl);

      // Elementi DOM
      const tbody = document.getElementById('serviziTableBody');
      const addForm = document.getElementById('addForm');
      const editForm = document.getElementById('editForm');

      // Funzione per aggiornare la tabella
      function caricaServizi() {
        const servizi = getServizi();
        tbody.innerHTML = '';
        servizi.forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><i class="${s.icona || s.icon}"></i></td>
            <td>${s.titolo || s.title}</td>
            <td>${s.descrizioneBreve || s.desc}</td>
            <td>
              <button class="btn-edit btn-sm" onclick="modificaServizio('${s.id}')"><i class="fas fa-pen"></i> Modifica</button>
              <button class="btn-delete btn-sm" onclick="eliminaServizio('${s.id}')"><i class="fas fa-trash"></i> Elimina</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Funzione per mostrare anteprime immagini da textarea
      function aggiornaPreview(textareaId, previewId) {
        const textarea = document.getElementById(textareaId);
        const preview = document.getElementById(previewId);
        if (!textarea || !preview) return;
        const urls = textarea.value.split('\n').map(u => u.trim()).filter(u => u !== '');
        preview.innerHTML = urls.map((url, index) => `
          <div class="preview-item">
            <img src="${url}" onerror="this.parentElement.style.display='none'">
            <button class="remove-img" type="button" onclick="rimuoviUrl('${textareaId}', '${previewId}', ${index})">&times;</button>
          </div>
        `).join('');
      }

      // Rimuovere un URL dal textarea e aggiornare preview
      window.rimuoviUrl = function(textareaId, previewId, index) {
        const textarea = document.getElementById(textareaId);
        let urls = textarea.value.split('\n').map(u => u.trim()).filter(u => u !== '');
        urls.splice(index, 1);
        textarea.value = urls.join('\n');
        aggiornaPreview(textareaId, previewId);
      };

      // Inizializza ascoltatori per i textarea delle immagini
      function initTextareaListeners() {
        ['addImmagini', 'editImmagini'].forEach(id => {
          const ta = document.getElementById(id);
          if (ta) {
            ta.addEventListener('input', function() {
              const previewId = id === 'addImmagini' ? 'addPreview' : 'editPreview';
              aggiornaPreview(id, previewId);
            });
          }
        });

        // Pulsanti "Aggiungi riga"
        document.getElementById('addAggiungiUrl')?.addEventListener('click', function() {
          const ta = document.getElementById('addImmagini');
          ta.value += '\n';
          ta.focus();
          aggiornaPreview('addImmagini', 'addPreview');
        });
        document.getElementById('editAggiungiUrl')?.addEventListener('click', function() {
          const ta = document.getElementById('editImmagini');
          ta.value += '\n';
          ta.focus();
          aggiornaPreview('editImmagini', 'editPreview');
        });
      }

      // Apri modale di modifica con i dati del servizio
      window.modificaServizio = function(id) {
        const servizi = getServizi();
        const s = servizi.find(s => s.id === id);
        if (!s) return;

        document.getElementById('editId').value = s.id;
        document.getElementById('editIcona').value = s.icona || s.icon || '';
        document.getElementById('editTitolo').value = s.titolo || s.title || '';
        document.getElementById('editDescBreve').value = s.descrizioneBreve || s.desc || '';
        document.getElementById('editDescEstesa').value = s.descrizioneEstesa || '';
        // Immagini: array -> testo (uno per riga)
        const immagini = s.immagini || [];
        document.getElementById('editImmagini').value = immagini.join('\n');
        document.getElementById('editPrezzo').value = s.prezzo || '';

        // Aggiorna anteprime
        aggiornaPreview('editImmagini', 'editPreview');

        editModal.show();
      };

      // Salva modifiche
      document.getElementById('salvaModifiche').addEventListener('click', function() {
        const id = document.getElementById('editId').value;
        const icona = document.getElementById('editIcona').value;
        const titolo = document.getElementById('editTitolo').value;
        const descBreve = document.getElementById('editDescBreve').value;
        const descEstesa = document.getElementById('editDescEstesa').value;
        const immaginiText = document.getElementById('editImmagini').value;
        const immagini = immaginiText.split('\n').map(u => u.trim()).filter(u => u !== '');
        const prezzo = document.getElementById('editPrezzo').value;

        const servizioAggiornato = {
          id: id,
          icona: icona,
          titolo: titolo,
          descrizioneBreve: descBreve,
          descrizioneEstesa: descEstesa,
          immagini: immagini,
          prezzo: prezzo
        };

        if (aggiornaServizio(servizioAggiornato)) {
          editModal.hide();
          caricaServizi();
        } else {
          alert('Errore durante il salvataggio');
        }
      });

      // Salva nuovo servizio
      document.getElementById('salvaNuovo').addEventListener('click', function() {
        const icona = document.getElementById('addIcona').value;
        const titolo = document.getElementById('addTitolo').value;
        const descBreve = document.getElementById('addDescBreve').value;
        const descEstesa = document.getElementById('addDescEstesa').value;
        const immaginiText = document.getElementById('addImmagini').value;
        const immagini = immaginiText.split('\n').map(u => u.trim()).filter(u => u !== '');
        const prezzo = document.getElementById('addPrezzo').value;

        const nuovoServizio = {
          icona: icona,
          titolo: titolo,
          descrizioneBreve: descBreve,
          descrizioneEstesa: descEstesa,
          immagini: immagini,
          prezzo: prezzo
        };

        aggiungiServizio(nuovoServizio);
        addModal.hide();
        addForm.reset();
        document.getElementById('addPreview').innerHTML = ''; // pulisci anteprime
        caricaServizi();
      });

      // Elimina servizio
      window.eliminaServizio = function(id) {
        if (confirm('Sei sicuro di voler eliminare questo servizio?')) {
          if (eliminaServizio(id)) {
            caricaServizi();
          }
        }
      };

      // All'avvio
      document.addEventListener('DOMContentLoaded', function() {
        caricaServizi();
        initTextareaListeners();

        // Pulisci form aggiunta quando si chiude il modal
        addModalEl.addEventListener('hidden.bs.modal', function() {
          addForm.reset();
          document.getElementById('addPreview').innerHTML = '';
        });
      });
    })();
  </script>
</body>
</html>
